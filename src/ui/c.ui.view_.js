define(["libs","cUIAlert","cUIWarning","cUIHeadWarning","cUIWarning404","cUIToast","cSales","cStorage","cBase","CommonStore","cUtility","cAdView","cUILoading"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a,b,c){a&&a.originalEvent&&alert(a.originalEvent.message+" "+b+" "+c)}var o=h.localStorage;return document.body&&(document.body.tabIndex=1e4),Backbone.View.extend({ENUM_STATE_NOCREATE:0,ENUM_STATE_CREATE:1,ENUM_STATE_LOAD:2,ENUM_STATE_SHOW:3,ENUM_STATE_HIDE:4,pageid:0,scrollPos:{x:0,y:0},header:null,footer:null,cSales:g,warning:null,alert:null,onCreate:function(){},viewInitialize:function(){},initialize:function(a,g,h){this.$el.addClass("sub-viewport"),this.id=_.uniqueId("viewport"),this.$el.attr("id","id_"+this.id),this.viewname=h,this.pageid&&this.$el.attr("page-id",this.pageid),this.viewdata={},this.appliction=g,this.request=a,this.$el.attr("page-url",this.request.viewpath),this.state=this.ENUM_STATE_CREATE,this.alert=new b({title:"提示信息",message:"",buttons:[{text:"知道了",click:function(){this.hide()}}]}),this.warning=new c({title:""}),this.headwarning=new d({title:""}),this.warning404=new e,this.loading=new m,this.toast=new f,_.isArray(this.css)&&this.appendCss(this.css),l&&(this.footer=l.getInstance()),this.debug();try{this.onCreate()}catch(i){}},_initializeHeader:function(){var a=this;this.header.backUrl&&this.$el.on("click","#js_return",function(){a.back(a.header.backUrl)}),this.header.home&&this.$el.delegate("#js_home","click",function(){a.home()}),this.header.phone&&this.$el.find("#js_phone").attr("href","tel:"+this.header.phone),this.header.title&&this.$el.find("header h1").text(this.header.title),this.header.subtitle&&this.$el.find("header p").text(this.header.subtitle),this.header.rightAction&&this.$el.delegate("header div","click",this.header.rightAction)},_initializeFooter:function(){if(this.footer&&this.footer.hide(),!k.isInApp()&&this.hasAd&&!this.footer.isExpire()){var a=this.adContainer?this.$el.find("#"+this.adContainer):$("#footer"),b=this.footer.rootBox;b&&b.attr("id")!=a.attr("id")&&(this.footer.remove(),this.footer.isCreate=!1),this.footer.update({rootBox:a}),this.footer.show()}},__onLoad:function(a){document.body&&document.body.focus(),this.getServerDate(),this.disposeChannel(),this.header=this._getDefaultHeader(),this.state=this.ENUM_STATE_LOAD,this.onLoad&&this.onLoad(a)},__onShow:function(){this.state=this.ENUM_STATE_SHOW,window.scrollTo(0,0);try{this.onShow&&this.onShow()}catch(a){}this._sendUbt(),this._initializeHeader(),this._initializeFooter(),this.__updateSales(this.$el),this.onBottomPull&&(this._onWidnowScroll=$.proxy(this.onWidnowScroll,this),this.addScrollListener()),this._sendGa(),this._sendKenshoo(),this.resetViewMinHeight()},resetViewMinHeight:function(){},__onHide:function(a){this.state=this.ENUM_STATE_HIDE,this.onHide&&this.onHide(a),this.hideHeadWarning(),this.hideWarning(),this.hideLoading(),this.hideWarning404(),this.hideToast(),this.onBottomPull&&this.removeScrollListener(),this.scrollPos={x:window.scrollX,y:window.scrollY}},showLoading:function(){this.loading.show()},hideLoading:function(){this.loading.hide()},forward:function(){this.appliction.forward.apply(null,arguments)},back:function(){this.appliction.back.apply(null,arguments)},jump:function(a,b){k.isInApp()?(a=a.replace(window.BASEURL,""),this.forward(a)):b?window.location.replace(a):window.location.href=a},home:function(){this.appliction.forward("")},setTitle:function(a){this.appliction.setTitle("携程旅行网-"+a)},restoreScrollPos:function(){window.scrollTo(this.scrollPos.x,this.scrollPos.y)},getQuery:function(a){return this.request.query[a]||null},getPath:function(a){return this.request.path[a]||null},getRoot:function(){return this.request.root||null},showMessage:function(a,b){this.alert.setViewData({message:a,title:b}),this.alert.show()},showWarning:function(a,b){a&&this.warning.setTitle(a,b),this.warning.show()},hideWarning:function(){this.warning.hide()},showHeadWarning:function(a,b,c){a&&this.headwarning.setTitle(a,b,c),this.headwarning.show()},hideHeadWarning:function(){this.headwarning.hide()},showWarning404:function(a){a&&this.warning404.retryClick(a),this.warning404.show()},hideWarning404:function(){this.warning404.hide()},showNoHeadWarning:function(a,b){a&&this.NoHeadWarning.setContent(a,b),this.NoHeadWarning.show()},showToast:function(a,b,c,d){this.toast.isShow()||(d="undefined"!=typeof d?d:!0,this.toast.show(a,b,c,d))},hideToast:function(){this.toast.hide()},updateHeader:function(a){for(var b in a)this.header[b]=a[b];this._initializeHeader()},_getDefaultHeader:function(){return{backUrl:null,home:!1,phone:null,title:null,subtitle:null,rightAction:null}},__updateSales:function(a){var b=location.host,c=document.referrer,d="";b&&-1===c.indexOf(b)&&(c=c.replace("http://","").replace("https://","").split("/")[0].toLowerCase(),c.indexOf("baidu")>-1&&(d="SEO_BAIDU"),c.indexOf("google")>-1&&(d="SEO_GOOGLE"),c.indexOf("soso.com")>-1&&(d="SEO_SOSO"),c.indexOf("sogou")>-1&&(d="SEO_SOGOU"),c.indexOf("m.so.com")>-1&&(d="SEO_SO"),c.indexOf("so.360")>-1&&(d="SEO_360SO"),c.indexOf("bing.com")>-1&&(d="SEO_BING"),c.indexOf("yahoo")>-1&&(d="SEO_YAHOO"),c.indexOf("youdao")>-1&&(d="SEO_YOUDAO"),(c.indexOf("jike.com")>-1||c.indexOf("babylon.com")>-1||c.indexOf("ask.com")>-1||c.indexOf("avg.com")>-1||c.indexOf("easou.com")>-1||c.indexOf("panguso.com")>-1||c.indexOf("yandex.com")>-1)&&(d="SEO_360SO"));var e=window.localStorage.getItem("SOURCEID"),f=this.getQuery("sourceid"),i=this.getQuery("sales"),k=j.SalesStore.getInstance().get(),l=this.getQuery("sales")||d||k&&k.sales,m=this.getQuery("sourceid")||e||k&&k.sourceid;(f&&+f>0||i&&i.length>0)&&h.localStorage.oldRemove("APP_DOWNLOAD"),l||m?(l&&g.setSales(l),m&&g.setSourceId(m),g.getSalesObject(l||m,$.proxy(function(b){if((!b.appurl||b.appurl.length<=0)&&this.footer&&this.footer.rootBox){var c=this.footer.rootBox.find("#dl_app");c.length>0&&c.hide()}this.warning404.tel=b.tel?b.tel:"4000086666",g.replaceContent(a)},this))):b&&-1===c.indexOf(b)&&(c=c.replace("http://","").replace("https://","").split("/")[0].toLowerCase(),c.indexOf("baidu")>-1&&(l="SEO_BAIDU"),c.indexOf("google")>-1&&(l="SEO_GOOGLE"),c.indexOf("soso.com")>-1&&(l="SEO_SOSO"),c.indexOf("sogou")>-1&&(l="SEO_SOGOU"),c.indexOf("m.so.com")>-1&&(l="SEO_SO"),c.indexOf("so.360")>-1&&(l="SEO_360SO"),c.indexOf("bing.com")>-1&&(l="SEO_BING"),c.indexOf("yahoo")>-1&&(l="SEO_YAHOO"),c.indexOf("youdao")>-1&&(l="SEO_YOUDAO"),(c.indexOf("jike.com")>-1||c.indexOf("babylon.com")>-1||c.indexOf("ask.com")>-1||c.indexOf("avg.com")>-1||c.indexOf("easou.com")>-1||c.indexOf("panguso.com")>-1||c.indexOf("yandex.com")>-1)&&(d="SEO_360SO"),l&&g.setSales(l),setTimeout(function(){g.replaceContent(a)},1))},getServerDate:function(a){return k.getServerDate(a)},now:function(){return k.getServerDate()},debug:function(){var a=this.request.query.debug||o.get("DEBUG");"yes"==a?($(window).unbind("error",n),$(window).bind("error",n),o.set("DEBUG",a,new i.Date(i.getServerDate()).addDay(1).valueOf())):"no"==a&&($(window).unbind("error",n),o.remove("DEBUG"))},_sendUbt:function(){if(window.$_bf&&1==window.$_bf.loaded){if(0==this.pageid)return;var a=this._getAurl(),b=this.request.query,c=$("#page_id"),d=$("#bf_ubt_orderid"),e=location.protocol+"//"+location.host+a,f=+this.pageid;k.isInApp()&&(f+=1e3,e="http://hybridm.ctrip.com/"+a.substr(a.indexOf("webapp"))),1==c.length&&c.val(f),1==d.length&&(b&&b.orderid?d.val(b.orderid):d.val("")),window.$_bf.asynRefresh({page_id:f,url:location.protocol+"//"+location.host+a})}else k.isInApp()||setTimeout($.proxy(this._sendUbt,this),300)},_sendGa:function(){if("undefined"!=typeof _gaq){var a=this._getAurl();_gaq.push(["_trackPageview",a])}else setTimeout($.proxy(this._sendGa,this),300)},_sendKenshoo:function(){var a=this.request.query;if(a&&a.orderid){var b="https://2113.xg4ken.com/media/redir.php?track=1&token=8515ce29-9946-4d41-9edc-2907d0a92490&promoCode=&valueCurrency=CNY&GCID=&kw=&product=";b+="&val="+a.val+"&orderId="+a.orderid+"&type="+a.type;var c="<img width='1' height='1' src='"+b+"'/>";$("body").append(c)}},_getAurl:function(){var a,b=this.request.root;return this.request.viewpath&&(b+="#"+this.request.viewpath),this.request.path.length>0&&(a=$.param(this.request.query),b+="!"+this.request.path.join("/")+(a.length?"?"+a:"")),b},disposeChannel:function(){var a,b=this.getQuery("allianceid"),c=this.getQuery("sid"),d=this.getQuery("ouid");if(b&&c){if(a={AllianceID:b,SID:c,OUID:d},j.UnionStore.getInstance().set(a),this.footer&&this.footer.rootBox){var e=this.footer.rootBox.find("#dl_app");e.length>0&&e.hide()}}else{var f=location.host,g=document.referrer;if(f&&-1===g.indexOf(f)&&(g=g.replace("http://","").replace("https://","").split("/")[0].toLowerCase(),g.indexOf("baidu")>-1&&(b=b||"4897",c=c||"353693",d=d||""),g.indexOf("google")>-1&&(b=b||"4899",c=c||"353694",d=d||""),g.indexOf("soso.com")>-1&&(b=b||"4900",c=c||"353696",d=d||""),g.indexOf("sogou")>-1&&(b=b||"4901",c=c||"353698",d=d||""),g.indexOf("m.so.com")>-1&&(b=b||"5376",c=c||"353699",d=d||""),g.indexOf("so.360")>-1&&(b=b||"5376",c=c||"353700",d=d||""),g.indexOf("bing.com")>-1&&(b=b||"4902",c=c||"353701",d=d||""),g.indexOf("yahoo")>-1&&(b=b||"4903",c=c||"353703",d=d||""),g.indexOf("youdao")>-1&&(b=b||"4904",c=c||"353704",d=d||""),(g.indexOf("jike.com")>-1||g.indexOf("babylon.com")>-1||g.indexOf("ask.com")>-1||g.indexOf("avg.com")>-1||g.indexOf("easou.com")>-1||g.indexOf("panguso.com")>-1||g.indexOf("yandex.com")>-1)&&(b=b||"5376",c=c||"353700",d=d||""),b&&c&&(a={AllianceID:b,SID:c,OUID:d},j.UnionStore.getInstance().set(a),this.footer&&this.footer.rootBox))){var e=this.footer.rootBox.find("#dl_app");e.length>0&&e.hide()}}},getGuid:function(){return k.getGuid()},setTitle:function(a){document.title=a},appendCss:function(a){if(a)for(var b=0,c=a.length;c>b;b++)this.css[a[b]]||(this.head.append($('<link rel="stylesheet" type="text/css" href="'+a[b]+'" />')),this.css[a[b]]=!0)},addClass:function(a){this.$el.addClass(a)},removeClass:function(a){this.$el.removeClass(a)},__load:function(){this.__onLoad()},__show:function(){this.viewport.find("#id_"+this.id).length||this.viewport.append(this.$el),this.$el.show(),this.__onShow()},__hide:function(){this.$el.hide(),this.__onHide()}})});