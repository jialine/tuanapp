define(["libs","c","cUIAnimation","cUtility","cWidgetFactory","cWidgetGuider"],function(a,b,c,d,e){var f=b.base,g="手机预订三亚门票，价格最低",h="",i=new b.base.Class({__propertys__:function(){this.webroot="/#hotelsearch",this.head=$("head"),this.body=$("body"),this.viewRootPath="app/views/",this.defaultView="index",this.request,this.viewpath,this.mainframe,this.viewport,this.statedom,this.views=new b.base.Hash,this.maxLength=5,this.curView,this.inteface={loadView:_.bind(this.loadView,this),forward:_.bind(this.forward,this),hideLoading:_.bind(this.hideLoading,this),showLoading:_.bind(this.showLoading,this),turning:_.bind(this.turning,this),back:_.bind(this.back,this),setTitle:_.bind(this.setTitle,this),appendCss:_.bind(this.appendCss,this)},this.isCreate=!1,this.history=[],this.loading,this.css={},this.stopListening=!1,this.onHashChange=_.bind(function(){if(window.history.length,this.history.push(window.location.href),!this.stopListening){var a=decodeURIComponent(window.location.hash.replace(/^#+/i,"")).toLowerCase();this._onHashChange(a)}},this),this._turning=function(){},this.timeoutres,this.lastHash="",this.lashFullHash="",this.isChangeHash=!1,this.animations=c,this.isAnimat=!0,this.isinapp=f.isInApp(),navigator.userAgent.toLowerCase().indexOf("ucbrowser")>0&&(this.isinapp=!1),this.notAnimatHandler=c.fadeIn,this.animForwardName="slideleft",this.animBackwardName="slideright",this.path=[],this.query={},this.viewMapping={}},buildUrl:function(a){var b=this.viewMapping[a];return b?b:this.viewRootPath+a},initialize:function(a){this.setOption(a),this.buildEvent(),this.createCommonUI();var b=e.create("Guider");b.create()},setOption:function(a){a=a||{};for(var b in a)switch(b){case"defaultView":case"viewRootPath":case"maxLength":case"webroot":case"path":case"query":case"baseUrl":case"viewRootPathMap":case"viewMapping":this[b]=a[b]}},lastUrl:function(){return this.history.length<2?document.referrer:this.history[this.history.length-2]},setTitle:function(a){document.title=a},localObserver:function(a,b){var c=b?this.animForwardName:this.animBackwardName;this.request=a,this.viewpath=this.request.viewpath||this.defaultView,this.request.viewpath=this.viewpath,this.switchView(this.viewpath,c)},startObserver:function(){this.stopListening=!1},endObserver:function(){this.stopListening=!0},showLoading:function(){var a=window.location.hash.replace(/^#+/i,""),b=a.substring(0,a.indexOf("/"));switch(b){case"vevent":this.loading.setHtml(g);break;default:this.loading.setHtml(h)}this.loading.show()},hideLoading:function(){this.loading.hide()},createViewPort:function(){if(!this.isCreate){var a=['<div class="main-frame">','<div class="main-viewport"></div>','<div class="main-state"></div>',"</div>"].join("");this.mainframe=$(a),this.viewport=this.mainframe.find(".main-viewport"),this.statedom=this.mainframe.find(".main-state");var b=$("#main");b.empty(),b.append(this.mainframe),this.isCreate=!0}},createCommonUI:function(){this.loading=new b.ui.Loading},buildEvent:function(){var a=this;requirejs.onError=function(c){if(c&&c.requireModules)for(var d=0;d<c.requireModules.length;d++){var e=new b.ui.Toast;e.show("抱歉，当前的网络状况不给力，请刷新重试!",2,function(){a.hideLoading()})}},$(window).bind("hashchange",this.onHashChange),this.onHashChange(),$.bindFastClick&&$.bindFastClick()},switchView:function(a,b){var c,d,e=a,f=this.views.getItem(e);if(f){if(this.curView&&this.curView!==f){this.curView.request=this.request,"function"==typeof this.curView.__onHide&&this.curView.__onHide(e),c=this.curView,this.curView=f,d=this.curView,d.request=this.request,this._turning=_.bind(function(){this.createViewPort(),d.$el.show(),this.startAnimation(d,c,b,$.proxy(function(){this.views.each(function(a){return d===a||c===a?!1:(a.$el.hide(),void 0)}),this.viewport.find("#id_"+d.id).length||this.viewport.append(d.$el),d.__onShow&&d.__onShow()},this))},this);var g=(c||this.curView).viewname;"function"==typeof this.curView.__onLoad&&this.curView.__onLoad(g),this.views.push(e,f,!0)}else if(this.isChangeHash){this.curView.request=this.request,d=this.curView,this._turning=_.bind(function(){this.createViewPort(),d.$el.show(),window.scrollTo(0,1),this.viewport.find("#id_"+d.id).length||this.viewport.append(d.$el),d.__onShow&&d.__onShow()},this);var g=(c||this.curView).viewname;"function"==typeof this.curView.__onLoad&&this.curView.__onLoad(g)}}else this.loadView(a,function(a){this.curView?("function"==typeof this.curView.__onHide&&this.curView.__onHide(e),c=this.curView,this.curView=new a(this.request,this.inteface,e),this.views.push(e,this.curView),d=this.curView,this._turning=_.bind(function(){this.createViewPort(),d.$el.show(),this.viewport.append(d.$el),this.startAnimation(d,c,b,$.proxy(function(){this.views.each(function(a){return d===a||c===a?!1:(a.$el.hide(),void 0)}),d.__onShow&&d.__onShow()},this))},this)):(this.curView=new a(this.request,this.inteface,e),this.views.push(e,this.curView),d=this.curView,this._turning=_.bind(function(){this.createViewPort(),d.$el.show(),this.viewport.append(d.$el),window.scrollTo(0,1),d.__onShow&&d.__onShow()},this));var f=(c||this.curView).viewname;"function"==typeof this.curView.__onLoad&&this.curView.__onLoad(f),this.views.length()>this.maxLength&&this.views.length()>2})},appendCss:function(a){if(a)for(var b=0,c=a.length;c>b;b++)this.css[a[b]]||(this.head.append($('<link rel="stylesheet" type="text/css" href="'+a[b]+'" />')),this.css[a[b]]=!0)},turning:function(){this._turning()},startAnimation:function(a,b,c,d){c=c||this.animBackwardName,this.isinapp||(this.isAnimat=!1),this.timeoutres=this.isAnimat?this.animations[c]&&this.animations[c].call(this,a,b,d,this):this.notAnimatHandler(a,b,d,this),this.isAnimat=!0},loadView:function(a,b){var c=this;requirejs([this.buildUrl(a)],function(a){b&&b.call(c,a)})},_onHashChange:function(a,b){a=a.replace(/^#+/i,"");var c=this.parseHash(a);this.localObserver(c,b)},forward:function(a,b,c){a=a.toLowerCase(),c&&(this.isAnimat=!1),this.endObserver(),b?window.location.replace(("#"+a).replace(/^#+/,"#")):window.location.href=("#"+a).replace(/^#+/,"#"),this._onHashChange(a,!0),setTimeout(_.bind(this.startObserver,this),1)},parseHash:function(a){var b,c,d=a,a=a.replace(/([^\|]*)(?:\|.*)?$/gim,"$1"),e=/^([^?&|]*)(.*)?$/i.exec(a),f=e[1]?e[1].split("!"):[],g=(f.shift()||"").replace(/(^\/+|\/+$)/i,""),h=f.length?f.join("!").replace(/(^\/+|\/+$)/i,"").split("/"):this.path,i=(e[2]||"").replace(/^\?*/i,"").split("&"),j=_.clone(this.query);if(this.isChangeHash=!(this.lastHash||d!==this.lashFullHash)||!(!this.lastHash||this.lastHash===a),i)for(var k=0;k<i.length;k++)i[k]&&(b=i[k].split("="),b[1]?(c=b.shift(),j[c]=b.join("=")):j[b[0]]="");return this.lastHash=a,this.lashFullHash=d,{viewpath:g,path:h,query:j,root:location.pathname+location.search,fullhash:d}},back:function(a,b){b&&(this.isAnimat=!1);var c=this.lastUrl();!a||c&&0===c.indexOf(a)?(a=this.request.query.refer,a?window.location.href=a:history.back()):window.location.hash=a}});return i});