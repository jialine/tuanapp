define(["cBase","cUIBase","cUtility","cWidgetFactory","cWidgetAbstractCalendar"],function(a,c,d,e){"user strict";var f="Calendar.Price";if(!e.hasWidget(f)){var g=e.create("Abstract.Calendar"),h=new a.Class(g,{__propertys__:function(){this.chineseHoliday=this.CONSTANT.CALENDAR_CHINESE_HOLIDAY,this.holiday=this.CONSTANT.CALENDAR_COMMON_HOLIDAY,this.DAYTITLE=this.CONSTANT.CALENDAR_WEEKDAY_SHORTNAME,this.SDAYTITLE=this.CONSTANT.CALENDAR_WEEKDAY_SHORTNAME2,this.addClass(c.config.prefix+this.CONSTANT.CALENDAR),this.showChineseHoliday=!0,this.showHoliday=!0,this.startMonth=d.getServerDate(),this.startMonth.setDate(this.CONSTANT.CALENDAR_INIT_DATE),this.Months=this.CONSTANT.CALENDAR_MONTH,this.validStartDate=d.getServerDate(),this.validStartDate.setHours(this.CONSTANT.INIT_DATE_TIME.H,this.CONSTANT.INIT_DATE_TIME.M,this.CONSTANT.INIT_DATE_TIME.S,this.CONSTANT.INIT_DATE_TIME.MS),this.validEndDate,this.date,this.onlyread=!1,this.dateVal={},this.cls=[this.CONSTANT.CALENDAR],this.curDate,this.dateDoms={},this.html,this.windowResizeHander,this._formatPrice=function(a,b){return b(a)},this.callback=function(){}},initialize:function(a,b){this.setOption(function(a,b){switch(a){case"Months":case"curDate":case"root":case"callback":case"onlyread":case"showChineseHoliday":this[a]=b;break;case"date":if(b)for(var c in b)this.dateVal[c]=b[c].value;this[a]=b;break;case"formatPrice":this._formatPrice=b;break;case"showHoliday":this[a]=b;break;case"validDates":this[a]=b;break;case"cls":this.cls.push(b);break;case"validStartDate":case"validEndDate":this[a]=b,this[a].setHours(1,1,1,0);break;case"startMonth":this[a]=b,this[a].setDate(1)}}),a(b),this.buildEvent()},selectedDate:function(){var a;for(var b in this.date)a=this.root.find("."+this.buildSelectCls(b))[0],this.dateDoms[b]=a,this.dateVal[b]=this.date[b].value;!this.curDate&&(this.curDate=b)},buildEvent:function(){this.addEvent("onCreate",this.onCreate),this.addEvent("onShow",this.onShow),this.addEvent("onHide",this.onHide)},onCreate:function(){this.selectedDate(),this.buildElementsEvent(),this.root.css({position:"absolute"}),this.windowResizeHander=$.proxy(this.position,this)},onShow:function(){$(window).bind("resize",this.windowResizeHander),this.setzIndexTop(),this.windowResizeHander()},position:function(){this.root.css({width:"auto",height:"auto",left:"0px",top:"0px"});var a=c.getPageSize();this.root.css({left:"0px",top:"0px",width:a.width,height:a.height})},onHide:function(){$(window).unbind("resize",this.windowResizeHander)},createHtml:function(){return this.createCalendar()},buildElementsEvent:function(){var c=this;this.root.delegate("li.valid","click",function(){b=$(this),b.hasClass("valid")||(b=b.closest(".valid"));var d=a.Date.parse(b.attr("data-date")).valueOf();c.isAccordBound(d)&&c._setDate(d,b)})},isAccordBound:function(b){var c=this.date[this.curDate];if(!c.bound)return!0;if(!c.bound.rules||!c.bound.error)return!0;var d,e=c.bound.rules;for(var f in e)switch(d="string"==typeof e[f]?this.dateVal[e[f]]:a.Type.isDate(e[f])&&e[f],f){case"<":if(!(d>b))return c.bound.error.call(this,b,this.curDate,this.dateVal),!1;break;case">":if(!(b>d))return c.bound.error.call(this,b,this.curDate,this.dateVal),!1;break;case"<=":if(!(d>=b))return c.bound.error.call(this,b,this.curDate,this.dateVal),!1;break;case">=":if(!(b>=d))return c.bound.error.call(this,b,this.curDate,this.dateVal),!1}return!0},_setDate:function(b,c){if(!this.onlyread){if(this.dateDoms[this.curDate]){var d=$(this.dateDoms[this.curDate]);d.html(this.formatTitle(a.Date.parse(d.attr("data-date")).valueOf())),d.removeClass(this.buildSelectCls(this.curDate)),d.removeClass(this.buildSelectCls())}this.dateDoms[this.curDate]=c;var e,f=$(c),g=this,h=this.date[this.curDate].title;e="function"==typeof h?function(a){return h(a,function(a){return g.formatTitle(a)})}:this.formatTitle;var i=parseFloat(parseInt(100*(c.attr("data-price")||0))/100),j=$.proxy(this.formatPrice,this);f.html(e.call(this,b)+this._formatPrice(i,j,!0)),f.addClass(this.buildSelectCls(this.curDate)),f.addClass(this.buildSelectCls()),this.dateVal[this.curDate]=b;var k=$.grep(this.validDates,function(a){var c=a.date.valueOf()==b.valueOf();return c}),i=0;k.length>0&&(i=k[0].price);var l=f.html().replace(/^\d+/gm,"");isNaN(l)===!1&&(l=this.DAYTITLE[b.getDay()]),this.callback&&this.callback.call(this,b,i,l,this.dateVal)}},setCurDate:function(a){this.curDate=a},buildSelectCls:function(a){return a?"selected-"+a:"cui_cld_daycrt"},createCalendar:function(){var a,b=[];b.push(['<article class="cont_wrap" style="margin: 0 0 0">','<div class="cui_cldwrap">'].join("")),b.push(this.createWeek());for(var c=0;c<this.Months;c++)a=new Date(this.startMonth),a.setMonth(a.getMonth()+c),b.push(this.createMonth(a));return b.push(["</div></atricle>"].join("")),b.join("")},createWeek:function(){var a=['<ul class="cui_cldweek">'];for(i in this.SDAYTITLE)a.push("<li>"+this.SDAYTITLE[i]+"</li>");return a.push("</ul>"),a.join("")},createMonth:function(b){var c,d=this.calcStructData(b),e=[];e.push('<section class="cui_cldunit">'),e.push('<h1 class="cui_cldmonth">'+a.Date.format(b,"Y年n月")+"</h1>"),e.push('<ul class="cui_cld_daybox">');for(var f,g,h=d.days.length,i=this,c=0;h>c;c++){g=d.days[c].length;for(var j=0;g>j;j++){f={};var k=d.days[c][j];if(k){var l=this.validStartDate||d.start,m=this.validEndDate||d.end;k>=l&&m>=k?(f.cui_cld_dayfuture=!0,f.valid=!0):(f.cui_cld_daypass=!0,f.invalid=!0)}else f.cui_cld_dayfuture=!0,f.invalid=!0;var n="";if(this.validDates&&k){var o=$.grep(this.validDates,function(a){return a.date.getFullYear()===k.getFullYear()&&a.date.getMonth()===k.getMonth()&&a.date.getDate()===k.getDate()?!0:!1});0===o.length?(delete f.valid,f.invalid=!0):(f.cui_cld_day_havetxt=!0,n=o[0].price)}var p=this.formatTitle;if(this.date)for(var q in this.date)this.dateVal[q]&&f.valid&&a.Date.format(this.dateVal[q]||this.date[q].value,"Y-m-d")==a.Date.format(d.days[c][j],"Y-m-d")&&(delete f.cui_cld_dayfuture,delete f.cui_cld_day_hint,f[this.buildSelectCls()]=!0,f[this.buildSelectCls(q)]=!0,p=function(a){return function(b){return a(b,function(a){return i.formatTitle(a)})}}(this.date[q].title));var r=$.proxy(this.formatPrice,this);e.push('<li data-price="'+n+'" data-date="'+a.Date.format(k,"Y-m-d")+'" '+(f?' class="'+a.Object.keys(f).join(" ")+'"':"")+"><em>"+p.call(this,k)+"</em>"+this._formatPrice(n,r,!!f.valid)+"</li>")}}return e.push("</ul></section>"),e.join("")},formatPrice:function(a){return a>0?"<i>&yen;"+a+"</i>":""},formatTitle:function(b){if(!b)return"";var c=d.getServerDate();if(a.Date.format(c,"Ymd")==a.Date.format(b,"Ymd"))return"今天";var e=new Date(b);e.setHours(1,1,1,0),c.setHours(1,1,1,0);var f=(e-c)/864e5;if(1==f)return"明天";if(2==f)return"后天";if(1==this.showChineseHoliday){var g=this.solarDay2(b);if(this.chineseHoliday[g])return this.chineseHoliday[g]}if(1==this.showHoliday){var h=a.Date.format(b,"md");if(this.holiday[h])return this.holiday[h]}return a.Date.format(b,"j")},calcStructData:function(a){var b=new Date(a),c=new Date(a);b.setDate(1),b.setHours(0,0,0,0);var d=b.getDay();c.setMonth(c.getMonth()+1,1),c.setHours(-24,0,0,0);for(var e,f=c.getDay(),g=(c.getDate()+(d+(6-f)))/7,h=[],i=0,j=0;g>i;i++){h[i]=[];for(var k=0;7>k;k++)if(0==i&&d>k)h[i].push("");else{if(e=new Date(b),e.setDate(e.getDate()+j),e>c)break;h[i].push(e),j++}}return{start:b,end:c,days:h,loops:g}},setDate:function(b){for(var c in b)if(this.date[c]&&a.Type.isDate(b[c])){b[c].setHours(1,1,1,0),this.date[c].value=b[c],this.dateVal[c]=b[c];var d=$(this.dateDoms[c]);d.removeCls(this.buildSelectCls(c)),d.removeCls(this.buildSelectCls());var e=$(this.root.query('[data-date="'+a.Date.format(b[c],"Y-m-d")+'"]')[0]);e.hasClass("valid")&&(e.addClass(this.buildSelectCls(c)),e.addClass(this.buildSelectCls())),this.dateDoms[c]=e}},getDate:function(){return this.dateVal}});e.register({name:f,fn:h})}});