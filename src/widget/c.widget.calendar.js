define(["cBase","cUIBase","cUIHashObserve","cUtility","cWidgetFactory","cWidgetAbstractCalendar"],function(a,c,d,e,f){"user strict";var g="Calendar";if(!f.hasWidget(g)){var h=f.create("Abstract.Calendar"),j=new a.Class(h,{__propertys__:function(){this.chineseHoliday=this.CONSTANT.CALENDAR_CHINESE_HOLIDAY,this.holiday=this.CONSTANT.CALENDAR_COMMON_HOLIDAY,this.DAYTITLE=this.CONSTANT.CALENDAR_WEEKDAY_SHORTNAME,this.SDAYTITLE=this.CONSTANT.CALENDAR_WEEKDAY_SHORTNAME2,this.DAYTITLE2=this.CONSTANT.CALENDAR_WEEKDAY_NAME,this.addClass(c.config.prefix+this.CONSTANT.CALENDAR),this.startMonth=e.getServerDate(),this.startMonth.setDate(this.CONSTANT.CALENDAR_INIT_DATE),this.Months=this.CONSTANT.CALENDAR_MONTH,this.validStartDate=e.getServerDate(),this.validStartDate.setHours(this.CONSTANT.INIT_DATE_TIME.H,this.CONSTANT.INIT_DATE_TIME.M,this.CONSTANT.INIT_DATE_TIME.S,this.CONSTANT.INIT_DATE_TIME.MS),this.validEndDate,this.date,this.dateVal={},this.titledom,this.leftback,this.cls=[this.CONSTANT.CALENDAR],this.title,this.noabsolute=!1,this.curDate,this.dateDoms={},this.html,this.windowResizeHander,this.clickEnabled=!0,this.msg="",this.callback=function(){},this.hashObserve=new d({hash:this.id,callback:function(){this.hide()},scope:this})},initialize:function(a,b){this.setOption(function(a,b){switch(a){case"Months":case"date":case"curDate":case"root":case"callback":case"title":case"noabsolute":case"msg":case"clickEnabled":this[a]=b;break;case"cls":this.cls.push(b);break;case"validStartDate":case"validEndDate":this[a]=b,this[a].setHours(0,0,0,0);break;case"startMonth":this[a]=b,this[a].setDate(1)}}),a(b),this.buildEvent()},selectedDate:function(){var a;for(var b in this.date)a=this.root.find("."+this.buildSelectCls(b))[0],this.dateDoms[b]=a,this.dateVal[b]=this.date[b].value;!this.curDate&&(this.curDate=b)},buildEvent:function(){this.addEvent("onCreate",this.onCreate),this.addEvent("onShow",this.onShow),this.addEvent("onHide",this.onHide)},buildElement:function(){this.titledom=this.root.find("header"),this.leftback=this.root.find("#js_return")},onCreate:function(){this.selectedDate(),this.buildElement(),this.buildElementsEvent(),this.noabsolute||this.root.css({position:"absolute"}),this.windowResizeHander=$.proxy(this.position,this)},onShow:function(){$(window).bind("resize",this.windowResizeHander),this.setzIndexTop(),this.windowResizeHander(),this.hashObserve.start()},position:function(){this.root.css({width:"auto",height:"auto",left:"0px",top:"0px"});var a=c.getPageSize();this.root.css({width:a.width,height:a.height})},onHide:function(){$(window).unbind("resize",this.windowResizeHander),this.hashObserve.end()},createHtml:function(){return this.createCalendar()},buildElementsEvent:function(){var c=this;this.clickEnabled&&this.root.delegate(".cui_cld_daybox li","click",function(){b=$(this),b.hasClass("valid")||(b=b.closest(".valid"));var d=b.attr("data-date");d&&(d=a.Date.parse(d).valueOf(),c.isAccordBound(d)&&c._setDate(d,b))}),this.root.delegate("#js_return","click",$.proxy(function(){this.hide()},this))},isAccordBound:function(b){var c=this.date[this.curDate];if(!c.bound)return!0;if(!c.bound.rules||!c.bound.error)return!0;var d,e=c.bound.rules;for(var f in e)if(d="string"==typeof e[f]?this.dateVal[e[f]]:a.Type.isDate(e[f])&&e[f],b.setHours(0,0,0,0),d)switch(d.setHours(0,0,0,0),f){case"<":if(!(d>b))return c.bound.error.call(this,b,this.curDate,this.dateVal),!1;break;case">":if(!(b>d))return c.bound.error.call(this,b,this.curDate,this.dateVal),!1;break;case"<=":if(!(d>=b))return c.bound.error.call(this,b,this.curDate,this.dateVal),!1;break;case">=":if(!(b>=d))return c.bound.error.call(this,b,this.curDate,this.dateVal),!1}return!0},_setDate:function(b,c){var d=this.root.find("."+this.buildSelectCls(this.curDate));d.each($.proxy(function(b,c){var e=$(c);e.html(this.formatTitle(a.Date.parse(d.attr("data-date")).valueOf())),e.removeClass(this.buildSelectCls(this.curDate)),e.removeClass(this.buildSelectCls())},this)),this.dateDoms[this.curDate]=c;var e,f=$(c),g=this.date[this.curDate].title;e="function"==typeof g?this.formatTitle2(g):this.formatTitle,f.html(e.call(this,b)),f.removeClass("cui_cld_dayfuture"),f.removeClass("cui_cld_day_hint"),f.addClass("cui_cld_day_havetxt"),f.addClass(this.buildSelectCls(this.curDate)),f.addClass(this.buildSelectCls()),this.dateVal[this.curDate]=b,this.callback&&this.callback.call(this,b,this.curDate,this.dateVal,this.getDateInfo(b),this.calendarend)},setCurDate:function(a){this.curDate=a,this.create();var b=this.getCurTitle();this.titledom.html(b)},getEndDate:function(){return this.calendarend},buildSelectCls:function(a){return a?"selected-"+a:"cui_cld_daycrt"},getCurTitle:function(){var a=this.date[this.curDate],b="";return a&&(b=a.headtitle||this.title),b||this.title},createCalendar:function(){var a,b=[],c=this.getCurTitle(),d=e.isInApp(),f=d?' style=" margin-top: 0"':"";this.title&&!d&&b.push(["<header>","<h1>"+c+'</h1><i class="returnico i_bef" id="js_return"></i>',"</header>"].join("")),b.push(['<article class="cont_wrap"',f,'><div class="cui_cldwrap">'].join("")),b.push(this.createWeek(d));for(var g=0;g<this.Months;g++)a=new Date(this.startMonth),a.setMonth(a.getMonth()+g),b.push(this.createMonth(a));return b.push(["</div></atricle>"].join("")),b.join("")},createWeek:function(a){var b=a?" cui_cldweek_top0":"",c=['<ul class="cui_cldweek'+b+'">'];this.msg&&c.push('<p  class="cui_cldmsg">'+this.msg+"</p>");for(i in this.SDAYTITLE)c.push("<li>"+this.SDAYTITLE[i]+"</li>");return c.push("</ul>"),c.join("")},createMonth:function(b){var c,d=this.calcStructData(b),e=[];e.push('<section class="cui_cldunit">'),e.push('<h1 class="cui_cldmonth">'+a.Date.format(b,"Y年n月")+"</h1>"),e.push('<ul class="cui_cld_daybox">');for(var f,g,h=d.days.length,c=0;h>c;c++){g=d.days[c].length;for(var i=0;g>i;i++){f={};var j=d.days[c][i];if(j){var k=this.validStartDate||d.start,l=this.validEndDate||d.end;j>=k&&l>=j?f.valid=!0:(f.cui_cld_daypass=!0,f.invalid=!0)}else f.cui_cld_dayfuture=!0,f.invalid=!0;var m,n=this.getDateInfo(j);if(n?(m=n.daytitle||n.holiday||n.chineseday,m?(f.cui_cld_day_havetxt=!0,(n.holiday||n.chineseday)&&(f.cui_cld_day_hint=!0),m="<em>"+n.date+"</em><i>"+m+"</i>"):m="<em>"+n.date+"</em>"):m="",this.date)for(var o in this.date)j&&a.Date.format(this.dateVal[o]||this.date[o].value,"Y-m-d")==a.Date.format(j,"Y-m-d")&&(delete f.cui_cld_dayfuture,delete f.cui_cld_day_hint,f.cui_cld_day_havetxt=!0,f[this.buildSelectCls()]=!0,f[this.buildSelectCls(o)]=!0,m=this.date[o].title(j,function(){return n.daytitle||n.holiday||n.chineseday||n.date}),m="<em>"+m+"</em>");e.push('<li data-date="'+a.Date.format(j,"Y-m-d")+'" '+(f?' class="'+a.Object.keys(f).join(" ")+'"':"")+">"+m+"</li>")}}return e.push("</ul></section>"),e.join("")},formatTitle:function(a){if(a){var b=this.getDateInfo(a);return b.holiday||b.chineseday||b.daytitle||b.date}return""},getDateInfo:function(b){if(b){var c=e.getServerDate(),d=new Date(b);d.setHours(1,1,1,0),c.setHours(1,1,1,0);var f=(d-c)/864e5,g={};g.daytitle=a.Date.format(c,"Ymd")==a.Date.format(b,"Ymd")?"今天":1==f?"明天":2==f?"后天":"";var h=this.solarDay2(b);g.chineseday=this.chineseHoliday[h]?this.chineseHoliday[h]:"";var i=a.Date.format(b,"md");return g.holiday=this.holiday[i]?this.holiday[i]:"",g.week=this.DAYTITLE[b.getDay()],g.week2=this.DAYTITLE2[b.getDay()],g.date=a.Date.format(b,"j"),g}},formatTitle2:function(a){return $.proxy(function(b){return a(b,$.proxy(function(a){return this.formatTitle(a)},this))},this)},calcStructData:function(a){var b=new Date(a),c=new Date(a);b.setDate(1),b.setHours(0,0,0,0);var d=b.getDay();c.setMonth(c.getMonth()+1,1),c.setHours(-24,0,0,0);for(var e,f=c.getDay(),g=(c.getDate()+(d+(6-f)))/7,h=[],i=0,j=0;g>i;i++){h[i]=[];for(var k=0;7>k;k++)if(0==i&&d>k)h[i].push("");else{if(e=new Date(b),e.setDate(e.getDate()+j),e>c)break;h[i].push(e),j++}}return this.calendarend=c,{start:b,end:c,days:h,loops:g}},setDate:function(b){this.create();for(var c in b)if(this.date[c]&&a.Type.isDate(b[c])){b[c].setHours(0,0,0,0),this.date[c].value=b[c],this.dateVal[c]=b[c];var d=this.root.find("."+this.buildSelectCls(c));if(d.length){var e=a.Date.parse(d.data("date")).valueOf();d.removeClass(this.buildSelectCls(c)),d.removeClass(this.buildSelectCls()),d.html(this.formatTitle(e))}var f=this.root.find('[data-date="'+a.Date.format(b[c],"Y-m-d")+'"]');f.each($.proxy(function(a,d){d=$(d),d.hasClass("valid")&&(d.addClass(this.buildSelectCls(c)),d.addClass(this.buildSelectCls()),d.html(this.formatTitle2(this.date[c].title)(b[c])))},this)),this.dateDoms[c]=f}},addDate:function(b,c){this.create();var d,e,f;for(var g in b)if(!this.date[g]||c){this.date[g]=b[g],d=this.date[g]&&this.date[g].value,e=this.date[g]&&this.date[g].title,e="function"==typeof e?this.formatTitle2(e):$.proxy(this.formatTitle,this);var h=this.root.find("."+this.buildSelectCls(g));h.length&&(h.removeClass(this.buildSelectCls(g)),h.removeClass(this.buildSelectCls())),d&&(f=this.root.find('[data-date="'+a.Date.format(d,"Y-m-d")+'"]'),f.each($.proxy(function(a,b){b=$(b),b.hasClass("valid")&&(b.html(e(d)),b.addClass(this.buildSelectCls(g)),b.addClass(this.buildSelectCls()),this.dateVal[g]=d)},this)))}},removeDate:function(b){this.create();for(var c,d=0,e=b.length;e>d;d++)if(c=b[d],this.date[c]){var f=this.root.find("."+this.buildSelectCls(c));f.each($.proxy(function(b,d){var e=$(d);e.removeClass(this.buildSelectCls(c)),e.removeClass(this.buildSelectCls()),e.html(this.formatTitle(a.Date.parse(e.data("date")).valueOf()))},this)),delete this.date[c],delete this.dateVal[c]}},getDate:function(){var a={};for(var b in this.date)a[b]=this.date[b].value;return _.isEmpty(this.dateVal)?_.isEmpty(a)?{}:a:this.dateVal},update:function(a){this.setOption(function(a,b){switch(a){case"Months":case"date":case"curDate":case"root":case"callback":case"title":case"noabsolute":this[a]=b;break;case"cls":this.cls.push(b);break;case"validStartDate":case"validEndDate":this[a]=b,this[a].setHours(0,0,0,0);break;case"startMonth":this[a]=b,this[a].setDate(1)}}),this.readOption(a),this.create(),this.root.html(this.createCalendar()),this.trigger("onChange")}});f.register({name:g,fn:j})}});