define(["cBase","cUICore","cWidgetFactory","libs"],function(a,b,c){"use strict";var d="Slide";if(!c.hasWidget(d)){var e=new a.Class({__propertys__:function(){this.images=[],this.index=1,this.delay=3,this.defaultIndex,this.autoplay=!1,this.root,this.imageinter,this.imageouter,this.navbox,this.navs,this.navinter,this.container,this.interWidth,this.itemWidth,this.onchange=function(){},this.onerror=function(){},this.loop=!0,this.ENUM_STATE_EMPTY=0,this.ENUM_STATE_NOTEMPTY=1,this.state=this.ENUM_STATE_EMPTY,this.notimage="",this.notimagedom,this.setTimeoutResoure,this.isMove=!1,this.dirs={left:"next",right:"pre"},this.dir="left",this.startX=0,this.startY=0},initialize:function(a){this.setOption(a),this.createLayout(),this.addImageItems(),setTimeout($.proxy(function(){this.calcinterWidth(),this.state===this.ENUM_STATE_NOTEMPTY&&(this.initposition(),this.autoplay&&this.play(),this.images&&this.images.length>1&&this.buildEvent())},this),1)},setOption:function(a){for(var b in a)switch(b){case"autoplay":case"defaultIndex":case"container":case"notimage":case"delay":case"dir":case"loop":case"onchange":case"onerror":this[b]=a[b];break;case"images":if(a[b]&&"string"==typeof a[b][0]){for(var c=[],d=0,e=a[b].length;e>d;d++)c.push({src:a[b][d]});this[b]=c}else this[b]=a[b]}},initposition:function(){this.go(this.index,function(){},!0),this.onchange(this.index,this.index);var a=this.calcNextIndex();this.setNavCurrent(a)},createLayout:function(){this.root=$(['<div class="'+b.config.prefix+'slide">','<div class="'+b.config.prefix+'slide-imgsouter">','<div class="'+b.config.prefix+'slide-imgsinter">',"</div>","</div>",'<div class="'+b.config.prefix+'slide-nav">','<div class="'+b.config.prefix+'slide-nav-padding">',"</div>","</div>","</div>"].join("")),this.imageouter=this.root.find("."+b.config.prefix+"slide-imgsouter"),this.imageinter=this.root.find("."+b.config.prefix+"slide-imgsinter"),this.navbox=this.root.find("."+b.config.prefix+"slide-nav"),this.navinter=this.root.find("."+b.config.prefix+"slide-nav-padding"),this.container.empty().append(this.root)},calcinterWidth:function(){var a=this.imageinter.find("."+b.config.prefix+"slide-img-item"),c=0;this.interWidth=c,this.itemWidth=this.imageouter.width(),a.css("width",this.itemWidth+"px"),a.each(function(){c+=$(this).width()}),this.imageinter.css("width",c+"px")},createImageItem:function(a,c,d){var e=[b.config.prefix+"slide-img-item"];c&&e.push(b.config.prefix+"slide-img-item-current"),d&&[].push.call(e,d);var f=$(['<div class="'+e.join(" ")+'">','<a href="'+(a.link?a.link:"javascript:void(0);")+'"><img src="'+a.src+'" title="'+(a.title||"")+'"/></a>',"</div>"].join("")),g=this;return f.find("img").bind("error",function(){var a=this;setTimeout(function(){g.notimage&&(a.src=g.notimage),g.onerror&&g.onerror(a),$(a).unbind("error")},100)}),f},addEmptyItem:function(a){var c=[b.config.prefix+"slide-img-item",b.config.prefix+"slide-img-item-empey"];this.notimagedom=$('<div class="'+c.join(" ")+'"></div>'),this.notimagedom.append(a),this.imageinter.append(this.notimagedom)},addImageItems:function(){for(var a=0,c=this.images.length;c>a;a++)this.addItem(this.images[a],this.defaultIndex===a);var d,e;this.images.length?(this.state=this.ENUM_STATE_NOTEMPTY,d=this.createImageItem(this.images[0],null,[b.config.prefix+"slide-img-pre"]),e=this.createImageItem(this.images[Math.max(0,this.images.length-1)],null,[b.config.prefix+"slide-img-last"]),this.loop||(d.css({visibility:"hidden"}),e.css({visibility:"hidden"})),this.imageinter.append(d),this.imageinter.prepend(e),this.navs=this.navinter.find("."+b.config.prefix+"slide-nav-item")):(this.state=this.ENUM_STATE_EMPTY,this.addEmptyItem(this.notimage))},buildEvent:function(){this.imageouter.bind("touchstart",$.proxy(this.onTouchStart,this)),this.imageouter.bind("touchmove",$.proxy(this.onTouchMove,this)),this.imageouter.bind("touchend",$.proxy(this.onTouchEnd,this)),this.imageouter.bind("touchcancel",$.proxy(this.onTouchEnd,this))},onTouchStart:function(a){if(a.preventDefault(),this.isMove)return this.isTouchStart=!1,void 0;this.isTouchStart=!0;var c=b.Tools.getMousePosOfElement(a.targetTouches[0],a.currentTarget);this.stop(),this.startX=c.x,this.startY=c.y,this.imageinterLeft=parseInt(this.imageinter.css("left"))},onTouchMove:function(a){if(a.preventDefault(),!this.isMove&&this.isTouchStart){var c=b.Tools.getMousePosOfElement(a.targetTouches[0],a.currentTarget),d=c.x-this.startX;c.y-this.startY,this.imageinter.css("left",this.imageinterLeft+d+"px")}},onTouchEnd:function(a){if(a.preventDefault(),!this.isMove&&this.isTouchStart){var c=b.Tools.getMousePosOfElement(a.changedTouches[0],a.currentTarget),d=c.x-this.startX,e=(c.y-this.startY,$.proxy(function(){this.autoplay&&this.loop&&this.play()},this)),f=this.calcNextIndex()+1,g=this.images.length;d>50&&this.loop||d>50&&!this.loop&&1!==f?this.pre(e):-50>d&&this.loop||-50>d&&!this.loop&&g>f?this.next(e):this.imageinter.animate({left:this.imageinterLeft+"px"},null,e)}},createNavItem:function(a){return $(['<span class="'+b.config.prefix+"slide-nav-item"+(a?b.config.prefix+"slide-nav-item-current":"")+'"></span>'].join(""))},addItem:function(a,b){var c=this.createImageItem(a,b),d=this.createNavItem(b);this.imageinter.append(c),this.navinter.append(d)},play:function(){clearInterval(this.setTimeoutResoure),!this.images||this.images.length<2||(this.setTimeoutResoure=setInterval($.proxy(function(){this[this.dirs[this.dir]]()},this),1e3*this.delay))},stop:function(){clearInterval(this.setTimeoutResoure)},go:function(a,b,c){this.isMove=!0;var d=-(this.itemWidth*a);c?(this.imageinter.css({left:d+"px"}),this.isMove=!1,b&&b()):this.imageinter.animate({left:d+"px"},null,null,$.proxy(function(){this.isMove=!1,b&&b()},this))},next:function(a){var b=this.index;this.go(++this.index,$.proxy(function(){if(this.index===this.images.length+1){this.index=1;var c=-(this.itemWidth*this.index);this.imageinter.css({left:c+"px"})}var d=this.calcNextIndex();this.setNavCurrent(d),this.onchange(this.index,b),a&&a()},this))},setNavCurrent:function(a){this.navs.removeClass(b.config.prefix+"slide-nav-item-current"),$(this.navs.get(a)).addClass(b.config.prefix+"slide-nav-item-current")},calcNextIndex:function(){return this.index>this.images.length?0:this.index-1},pre:function(a){0==this.index&&(this.index=1);var b=this.index;this.go(--this.index,$.proxy(function(){if(0===this.index){this.index=this.images.length;var c=-(this.itemWidth*this.index);this.imageinter.css({left:c+"px"})}var d=this.calcPreIndex();this.setNavCurrent(d),this.onchange(this.index,b),a&&a()},this))},calcPreIndex:function(){return this.index<1?Math.max(0,this.images.length-1):this.index-1},empty:function(){this.stop(),this.imageinter.find("img").remove()}});c.register({name:d,fn:e})}});